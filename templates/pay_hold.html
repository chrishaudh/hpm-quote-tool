<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secure Your Appointment – Hawkins Pro Mounting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; max-width:700px; margin:0 auto; padding:1.5rem; background:#f7f7f7; }
    .card { background:#fff; border-radius:0.75rem; padding:1.25rem 1.5rem; box-shadow:0 4px 14px rgba(0,0,0,0.05); }
    h1 { font-size:1.4rem; margin:0 0 0.5rem; }
    p { color:#4b5563; margin:0.25rem 0; }
    #card-element { border:1px solid #d1d5db; border-radius:0.5rem; padding:0.75rem; background:#fff; margin-top:0.75rem; }
    button { margin-top:1rem; width:100%; padding:0.85rem 1.25rem; border-radius:999px; border:none; font-weight:700; cursor:pointer; background:#2563eb; color:#fff; font-size:1rem; }
    button:hover { background:#1d4ed8; }
    .muted { font-size:0.85rem; color:#6b7280; margin-top:0.75rem; }
    .error { color:#b91c1c; margin-top:0.75rem; }
    .success { color:#166534; margin-top:0.75rem; }
  </style>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <div class="card">
    <h1>Secure your appointment (${{ amount_dollars }} hold)</h1>
    <p>This places a temporary hold to lock in your booking time.</p>
    <p class="muted">You’ll receive a receipt once your card is authorized.</p>
    <p class="muted">
     <strong>{{ service_type }}</strong>
     {% if time_slot %} • {{ time_slot }}{% endif %}
    </p>

    <div id="card-element"></div>
    <div id="msg" class="muted"></div>

    <button id="payBtn">Authorize ${{ amount_dollars }} Hold</button>
    <div id="err" class="error"></div>
    <div id="ok" class="success"></div>
  </div>

  <script>
    const publishableKey = {{ publishable_key|tojson }};
    const stripe = Stripe(publishableKey);

    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    const payBtn = document.getElementById("payBtn");
    const errBox = document.getElementById("err");
    const okBox = document.getElementById("ok");
    const msgBox = document.getElementById("msg");

    // ✅ SAFE: Server values serialized as JSON (won’t break JS)
    const bookingPayload = {
        service_type: {{ service_type|tojson }},
        time_slot: {{ time_slot|tojson }},
        appointment_date: {{ appointment_date|tojson }},
        appointment_time: {{ appointment_time|tojson }},

        services_this_visit_raw: {{ services_this_visit_raw|tojson }},
        num_services: {{ num_services|tojson }},
        estimated_hours: {{ estimated_hours|tojson }},

        name: {{ name|tojson }},
        email: {{ email|tojson }},
        phone: {{ phone|tojson }},

        address_street: {{ address_street|tojson }},
        address_city: {{ address_city|tojson }},
        address_state: {{ address_state|tojson }},
        address_zip: {{ address_zip|tojson }},

        notes: {{ notes|tojson }},
    };

    // ✅ Convert types for /book (FastAPI Form fields)
    if (bookingPayload.num_services !== "" && bookingPayload.num_services != null) {
        const n = parseInt(bookingPayload.num_services, 10);
        bookingPayload.num_services = isNaN(n) ? "" : n;
    }

    if (bookingPayload.estimated_hours !== "" && bookingPayload.estimated_hours != null) {
        const h = parseFloat(bookingPayload.estimated_hours);
        bookingPayload.estimated_hours = isNaN(h) ? "" : h;
    }

    async function createIntent() {
        const resp = await fetch("/api/create-hold-intent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(bookingPayload),
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || "Failed to start payment");
        return data.client_secret;
    }

    function postToBook(paymentIntentId) {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/book";

        for (const [key, val] of Object.entries(bookingPayload)) {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = key;
        input.value = (val === null || val === undefined) ? "" : String(val);
        form.appendChild(input);
        }

        const pi = document.createElement("input");
        pi.type = "hidden";
        pi.name = "payment_intent_id";
        pi.value = paymentIntentId;
        form.appendChild(pi);

        document.body.appendChild(form);
        form.submit();
    }

    payBtn.addEventListener("click", async () => {
        errBox.textContent = "";
        okBox.textContent = "";
        msgBox.textContent = "Starting secure authorization…";
        payBtn.disabled = true;

        try {
        const clientSecret = await createIntent();

        const result = await stripe.confirmCardPayment(clientSecret, {
            payment_method: { card: card },
        });

        if (result.error) throw new Error(result.error.message || "Authorization failed");

        const paymentIntentId = result.paymentIntent && result.paymentIntent.id;
        if (!paymentIntentId) throw new Error("Payment succeeded but PaymentIntent ID was missing.");

        okBox.textContent = "Hold authorized ✅ Finalizing your booking…";
        msgBox.textContent = "";

        postToBook(paymentIntentId);
        payBtn.disabled = true;
        } catch (e) {
        errBox.textContent = e.message;
        msgBox.textContent = "";
        payBtn.disabled = false;
        }
    });
  </script>
</body>
</html>
